//TODO: make loader work
//todo: make it responsive

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="Icons/brain.png" type="image/x-icon" />
  <title>Home</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous" />
  <script src="https://kit.fontawesome.com/d362cfdaed.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="homestyle.css">

</head>

<body class="active" onload="loadfun()">


  <!--  <div id="loader"></div> -->
  <!-- Sidebar -->
  <section class="wrapper active">
    <!--Top menu -->
    <nav class="sidebar">
      <div class="p-3 sidebar-heading">
        <h5 class="d-flex fa-align-item-center">
          <i class="fa-solid fa-compass mr-2"></i>
          Menu
        </h5>
      </div>
      <!--profile image & text-->
      <div class="profile px-3 mt-2">
        <h6 class="pt-1 mb-1">Account</h6>
        <h7 id="user" class="w-100 text-truncate" style="display: inline-block;">----</h7>
      </div>
      <!--menu item-->
      <ul>
        <li>
          <a href="#" class="active">
            <span class="icon"><i class="fa-solid fa-house"></i></span>
            <span class="item" id="home_btn">Home</span>
          </a>
        </li>
        <li>
          <a href="#">
            <span class="icon"><i class="fas fa-desktop"></i></span>
            <span class="item" id="dash_btn">My Dashboard</span>
          </a>
        </li>
      </ul>
    </nav>
  </section>

  <!-- Homepage w/o Sidebar -->
  <section class="home active">
    <nav id="navbar" class="navbar bg-body-primary px-3">
      <div>
        <button type="button" id="menu1" class="btn btn-primary mr-2">
          <i class="fa-solid fa-bars"></i>
        </button>
        <a class="navbar-brand" href="#">Quiz.com</a>
      </div>
      <ul class="nav nav-pills">
        <li class="nav-item">
          <a class="nav-link" href="#about">About</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#contact">Contact</a>
        </li>
        <li class="nav-item">
          <a id="userlink" class="nav-link mx-1" href="#">UserName</a>
        </li>
        <li class="nav-item">
          <a id="logoutlink" class="nav-link mx-1" href="#">Log Out</a>
        </li>
      </ul>
    </nav>
    <!-- Homepage w/o Dashboard -->
    <section id="onlyhome">
      <!-- Navbar Homepage -->

      <section>
        <div class="spacer layer1">
          <h1 class="text-pop-up-top ">Quiz.com
          </h1>
        </div>
      </section>
      <div data-bs-spy="scroll" data-bs-target="#navbar-example2" data-bs-root-margin="0px 0px -40%"
        data-bs-smooth-scroll="true" class="scrollspy-example bg-body-tertiary p-3 rounded-2" tabindex="0">
        <div id="category">
          <div class="d-flex justify-content-center">
            <h4>Category</h4>
          </div>
          <div class="d-flex align-items-center justify-content-center">
            <div class="card pl-3 mb-3 mr-3" style="width: 18rem;">
              <div class="card-body">
                <h5 class="card-title">Test quiz</h5>
                <a href="start1.html" class="link d-flex justify-content-start">Test Quiz 1</a>
                <a href="start1.html" class="link d-flex justify-content-start">Test Quiz 2</a>
              </div>
            </div>
            <div class="card pl-3 mb-3 mr-3" style="width: 18rem;">
              <div class="card-body">
                <h5 class="card-title">Letter and number series</h5>
                <a href="start2.html" class="link d-flex justify-content-start">Select</a>
              </div>
            </div>
            <div class="card pl-3 mb-3 mr-3" style="width: 18rem;">
              <div class="card-body">
                <h5 class="card-title">Verbal Analogy</h5>
                <a href="start3.html" class="link d-flex justify-content-start">Select</a>
                <a href="start3.html" class="link d-flex justify-content-start">Select</a>
              </div>
            </div>
            <div class="card pl-3 mb-3 mr-3" style="width: 18rem;">
              <div class="card-body">
                <h5 class="card-title">Programing</h5>
                <a href="start4.html" class="link d-flex justify-content-start">Select</a>
                <a href="start4.html" class="link d-flex justify-content-start">Select</a>
              </div>
            </div>
          </div>
        </div>
        <div id="about">
          <h4 class="d-flex justify-content-center">About us</h4>
          <p>...</p>
        </div>
        <div id="contact">
          <h4 class="d-flex justify-content-center">Contact</h4>
          <p>...</p>
        </div>
      </div>
    </section>
    <!-- Dashboard -->
    <section class="dashboard">
      <div hidden id="spinner"></div>
      <!-- <div class="border-bottom p-3" style="height: 57px;">
        <button type="button" id="menu3" class="btn btn-primary">
          <i class="fa-solid fa-bars"></i>
        </button>
      </div> -->
      <div class="mx-5 mt-4 ">
        <div class="mb-4 ml-3">
          <h5 class="font-weight-bolder mb-1">Dashboard</h5>
          <h7 id="user1" class="message"></h7>
        </div>
        <table class="table">
          <thead class="bg-primary table-dark">
            <tr>
              <th scope="col">#</th>
              <th scope="col">Quiz</th>
              <th scope="col">Score(/10)</th>
              <th scope="col">Time</th>
            </tr>
          </thead>
          <tbody id="tbody1"></tbody>
        </table>
      </div>
    </section>
  </section>


  <!--------------------------------script------------------------------------------------------------------------------------------------>
  <script>
    var load = document.getElementById("loader");
    function loadfun() {
      load.style.display = 'none';
    }
  </script>
  <script type="module">

    // -------------------------------Firebase configuration----------------------------------//
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";

    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

    import { getDatabase, ref, get, child, onValue } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

    // Web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBODwSzpJvyU6DJSkgMqimtGrjd3rtc4HE",
      authDomain: "quizdb-639e8.firebaseapp.com",
      databaseURL: "https://quizdb-639e8-default-rtdb.firebaseio.com",
      projectId: "quizdb-639e8",
      storageBucket: "quizdb-639e8.appspot.com",
      messagingSenderId: "363980400085",
      appId: "1:363980400085:web:72bf87fbccaa543b45495c",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    // Initialize variables
    const auth = getAuth()
    const db = getDatabase();

    //------------------------------References-------------------------------------------------//

    const logout_btn = document.getElementById("out_btn")
    const menu = document.querySelector("#menu1");
    const home_page = document.querySelector("#onlyhome");
    const dash = document.querySelector(".dashboard");
    const dashmenu = document.querySelector("#men2");
    const closemenu = document.querySelector("#menu3");
    const dash_btn = document.querySelector("#dash_btn");
    const home_btn = document.querySelector("#home_btn");
    const spinner = document.getElementById("spinner");
    var userId = null


    //------------------------assign events----------------------------------------//

    //-----------------------Checked if loged in (compulsary)-----------------------------------//

    onAuthStateChanged(auth, (user) => {
      document.getElementById("user").innerHTML = user.email
      document.getElementById("user1").innerHTML = user.email
      document.querySelector("#userlink").innerHTML = user.email                  //user email display
    });

    //------------------------------on login----------------------------------------------//

    let userlink = document.querySelector("#userlink")
    let logoutlink = document.querySelector("#logoutlink")
    var currentUser = null;

    function getUsername() {
      let keepLoggedIn = localStorage.getItem("keepLoggedIn")

      if (keepLoggedIn == "yes") {
        currentUser = (localStorage.getItem('user'))
        userId = localStorage.getItem("userId");
      }
      else {
        currentUser = (sessionStorage.getItem('user'))
        userId = sessionStorage.getItem("userId");
      }
    }

    window.onload = function () {
      console.log(currentUser)
      getUsername();
      if (currentUser == null) {
        userlink.innerHTML = "Create New Account"
        userlink.classList.replace("nav-link", "btn")
        userlink.classList.add("btn-primary")
        userlink.href = "register.html"

        logoutlink.innerHTML = "Log In"
        logoutlink.classList.replace("nav-link", "btn")
        logoutlink.classList.add("btn-primary")
        logoutlink.href = "login.html"
      }
      else {
        userlink.classList.replace("btn", "nav-link")
        userlink.classList.remove("btn-primary")
        userlink.href = "#"

        logoutlink.innerHTML = "Log Out"
        logoutlink.classList.replace("btn", "nav-link")
        logoutlink.classList.remove("btn-primary")
        logoutlink.addEventListener('click', logout);

      }
    }

    //---------------------------------logout script-------------------------------------------//

    function logout() {
      signOut(auth).then(() => {
        alert("signout sucessful")
        sessionStorage.removeItem('user')
        sessionStorage.removeItem('userId')
        localStorage.removeItem('user')
        localStorage.removeItem('keepLoggedIn')
        localStorage.removeItem('userId')
        document.getElementById("user").innerHTML = ""
        document.getElementById("user1").innerHTML = ""
        window.location = "index.html"
      }).catch((error) => {
        alert("error" + error)
      });
    }

    //---------------------------------homepage script-------------------------------------------//

    menu.addEventListener("click", sidebr)
    /* dashmenu.addEventListener("click", sidebr)
    closemenu.addEventListener("click", sidebr) */

    function sidebr() {
      document.querySelector("body").classList.toggle("active");
    }

    dash.style.display = 'none'

    dash_btn.onclick = () => {
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          alert("Log in first");
        }
        else {
          home_page.style.display = 'none'
          dash.style.display = 'block'
          document.querySelector(".nav-pills").style.display = 'none'
          getDataFromDb();
        }
      })
    };

    home_btn.onclick = () => {
      location.replace("index.html")
    };

    //---------------------------------Dashboard script-------------------------------------------//

    var serial = 0
    var tbody = document.querySelector("#tbody1")

    function AddToTable(quizn, score, time) {
      let trow = document.createElement("tr")
      let td1 = document.createElement('td')
      let td2 = document.createElement('td')
      let td3 = document.createElement('td')
      let td4 = document.createElement('td')

      td1.innerHTML = ++serial;
      td2.innerHTML = quizn;
      td3.innerHTML = score;
      td4.innerHTML = time;

      trow.appendChild(td1)
      trow.appendChild(td2)
      trow.appendChild(td3)
      trow.appendChild(td4)

      tbody.appendChild(trow)
      spinner.setAttribute('hidden', '');
    }

    function AddAllToTable(TheScore) {
      serial = 0;
      tbody.innerHTML = "";
      TheScore.forEach(element => {
        AddToTable(element.quiz_name, element.final_score, element.time);
      });
    }

    function getDataFromDb() {

      spinner.removeAttribute('hidden');

      const dbref = ref(db, "/Users/" + userId + "/Score");
      onValue(dbref, (snapshot) => {
        var scores = [];
        snapshot.forEach(childSnapshot => {
          scores.push(childSnapshot.val());
        });
        AddAllToTable(scores)
      })
    }

  </script>

</body>

</html>